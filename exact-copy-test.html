<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完全模仿image-embedding-tool的测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .example-item { 
            display: inline-block; 
            margin: 10px; 
            padding: 10px; 
            border: 2px solid #ccc; 
            cursor: pointer;
            border-radius: 8px;
        }
        .example-item.selected { border-color: #007bff; background: #f0f8ff; }
        .example-item img { width: 100px; height: 100px; object-fit: cover; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        #result { margin-top: 20px; padding: 20px; background: #f5f5f5; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        #preview { max-width: 200px; max-height: 200px; border: 1px solid #ccc; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>完全模仿image-embedding-tool的测试</h1>
    
    <div>
        <h2>示例图像:</h2>
        <div class="example-item" data-image="gray.jpg">
            <img src="gray.jpg" class="example-thumbnail" alt="灰度图">
            <div class="example-name">灰度图</div>
        </div>
        <div class="example-item" data-image="xidian.jpg">
            <img src="xidian.jpg" class="example-thumbnail" alt="校徽">
            <div class="example-name">校徽</div>
        </div>
    </div>
    
    <div>
        <button id="testBtn">测试Canvas操作</button>
        <button id="clearBtn">清除</button>
    </div>
    
    <div id="result">
        <h3>测试结果:</h3>
        <div id="status">请选择一张示例图像</div>
        <div id="details"></div>
        <img id="preview" style="display: none;" alt="预览图片">
    </div>

    <script>
        // 完全模仿image-embedding-tool的代码结构
        class TestProcessor {
            constructor() {
                this.correctImage = null;
                this.correctUploaded = false;
                this.setupExampleImage();
            }
            
            setupExampleImage() {
                const exampleItems = document.querySelectorAll('.example-item');
                exampleItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const imagePath = item.getAttribute('data-image');
                        this.useExampleImage(imagePath);

                        // 更新选中状态
                        exampleItems.forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                });
            }
            
            useExampleImage(imagePath = 'gray.jpg') {
                console.log('Using example image:', imagePath);
                
                const img = new Image();
                img.onload = () => {
                    console.log('Image loaded:', imagePath, img.width, 'x', img.height);
                    this.correctImage = img;
                    this.correctUploaded = true;
                    this.showCorrectionPreview(imagePath);
                };
                
                img.onerror = (error) => {
                    console.error('Image load failed:', error);
                    document.getElementById('status').innerHTML = `<span class="error">图片加载失败: ${imagePath}</span>`;
                };
                
                // 完全模仿image-embedding-tool的方式
                img.src = imagePath;
            }
            
            showCorrectionPreview(src) {
                const preview = document.getElementById('preview');
                if (preview) {
                    preview.src = src;
                    preview.style.display = 'block';
                    document.getElementById('status').innerHTML = `<span class="success">图片加载成功: ${src}</span>`;
                }
            }
            
            // 模仿homography.js中的canvas操作
            testCanvasOperation() {
                if (!this.correctImage) {
                    alert('请先选择一张示例图像');
                    return;
                }
                
                console.log('Testing canvas operation with image:', this.correctImage.src);
                
                try {
                    // 完全模仿homography.js中的代码
                    const sourceCanvas = document.createElement('canvas');
                    const sourceCtx = sourceCanvas.getContext('2d');
                    sourceCanvas.width = this.correctImage.width;
                    sourceCanvas.height = this.correctImage.height;
                    
                    // 绘制图像
                    sourceCtx.drawImage(this.correctImage, 0, 0);
                    
                    // 尝试getImageData
                    const sourceData = sourceCtx.getImageData(0, 0, this.correctImage.width, this.correctImage.height);
                    
                    console.log('Canvas operation successful!', sourceData.width, 'x', sourceData.height);
                    
                    // 分析图像数据
                    const analysis = this.analyzeImageData(sourceData);
                    
                    document.getElementById('status').innerHTML = `<span class="success">✓ Canvas操作成功!</span>`;
                    document.getElementById('details').innerHTML = `
                        <strong>成功详情:</strong><br>
                        • 图片尺寸: ${this.correctImage.width} × ${this.correctImage.height}<br>
                        • getImageData: <span class="success">成功</span><br>
                        • 图像数据长度: ${sourceData.data.length}<br>
                        • 图像类型: ${analysis.isGrayscale ? '灰度图像' : '彩色图像'}<br>
                        • 平均颜色: RGB(${analysis.avgColor.r}, ${analysis.avgColor.g}, ${analysis.avgColor.b})<br>
                        • 模仿image-embedding-tool: <span class="success">完全成功</span>
                    `;
                    
                } catch (error) {
                    console.error('Canvas operation failed:', error);
                    document.getElementById('status').innerHTML = `<span class="error">✗ Canvas操作失败: ${error.message}</span>`;
                    document.getElementById('details').innerHTML = `
                        <strong>失败详情:</strong><br>
                        ${error.message}<br><br>
                        <strong>这说明:</strong><br>
                        即使完全模仿image-embedding-tool的代码，仍然遇到跨域问题。<br>
                        可能的原因：<br>
                        1. 浏览器版本或设置不同<br>
                        2. 操作系统安全策略不同<br>
                        3. 需要特定的运行环境
                    `;
                }
            }
            
            analyzeImageData(imageData) {
                const { data } = imageData;
                let totalR = 0, totalG = 0, totalB = 0;
                let grayscalePixels = 0;
                const totalPixels = imageData.width * imageData.height;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    totalR += r;
                    totalG += g;
                    totalB += b;
                    
                    const tolerance = 5;
                    if (Math.abs(r - g) <= tolerance && Math.abs(g - b) <= tolerance && Math.abs(r - b) <= tolerance) {
                        grayscalePixels++;
                    }
                }
                
                const avgColor = {
                    r: Math.floor(totalR / totalPixels),
                    g: Math.floor(totalG / totalPixels),
                    b: Math.floor(totalB / totalPixels)
                };
                
                const isGrayscale = (grayscalePixels / totalPixels) >= 0.95;
                
                return { isGrayscale, avgColor };
            }
            
            clear() {
                this.correctImage = null;
                this.correctUploaded = false;
                
                document.querySelectorAll('.example-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                document.getElementById('status').textContent = '请选择一张示例图像';
                document.getElementById('details').innerHTML = '';
                document.getElementById('preview').style.display = 'none';
            }
        }
        
        // 初始化
        const processor = new TestProcessor();
        
        // 按钮事件
        document.getElementById('testBtn').addEventListener('click', () => {
            processor.testCanvasOperation();
        });
        
        document.getElementById('clearBtn').addEventListener('click', () => {
            processor.clear();
        });
    </script>
</body>
</html>
